generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CLINIC_DOCTOR
  HYGIENIST
  RECEPTIONIST
  EXTERNAL_DOCTOR
}

enum ClinicType {
  INDIVIDUAL_PRACTICE
  CLINIC
  MULTI_LOCATION_CLINIC
}

enum ClinicalImageType {
  XRAY
  INTRAORAL
  EXTRAORAL
  PERIAPICAL
  BITEWING
  PANORAMIC
  CEPHALOMETRIC
  CBCT
  BEFORE_TREATMENT
  DURING_TREATMENT
  AFTER_TREATMENT
  OTHER
}

enum ConsentStatus {
  PENDING
  SIGNED
  REVOKED
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                  String      @id @default(cuid())
  name                String?
  email               String?     @unique
  username            String?     @unique
  emailVerified       DateTime?
  password            String?
  image               String?
  role                Role        @default(CLINIC_DOCTOR)
  isExternal          Boolean     @default(false)
  clinicId            String?
  failedLoginAttempts Int         @default(0)
  lastLoginAt         DateTime?
  lockedUntil         DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  accounts            Account[]
  patients            Patient[]
  sessions            Session[]
  treatments          Treatment[]
  clinic              Clinic?     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicalImages      ClinicalImage[]
  consentsSigned      PatientConsent[] @relation("SignedBy")
  invoicesCreated     Invoice[]
  paymentsRecorded    Payment[]
  stockMovements      StockMovement[]

  @@index([username])
  @@index([clinicId])
}

model SuperAdmin {
  id          String    @id @default(cuid())
  name        String
  email       String    @unique
  password    String
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Clinic {
  id                  String        @id @default(cuid())
  name                String
  clinicCode          String        @unique
  type                ClinicType    @default(CLINIC)
  email               String
  phone               String?
  address             String?
  city                String?
  state               String?
  pinCode             String?
  website             String?
  registrationNumber  String?
  logo                String?
  isActive            Boolean       @default(true)
  ownerName           String
  ownerEmail          String
  planType            String        @default("free")
  maxUsers            Int           @default(5)
  onboardingComplete  Boolean       @default(false)
  onboardingStep      Int           @default(1)
  privacyAcceptedAt   DateTime?
  termsAcceptedAt     DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  users               User[]
  patients            Patient[]
  invitations         Invitation[]
  invoices            Invoice[]
  suppliers           Supplier[]
  inventoryItems      InventoryItem[]

  @@index([clinicCode])
}

model Patient {
  id                    String        @id @default(cuid())
  firstName             String
  lastName              String
  dateOfBirth           DateTime
  gender                String
  bloodGroup            String?
  height                Float?
  weight                Float?
  mobileNumber          String
  alternateMobileNumber String?
  email                 String?
  address               String
  city                  String
  state                 String
  pinCode               String
  aadharNumber          String?
  emergencyContactName  String?
  emergencyMobileNumber String?
  relationship          String?
  medicalHistory        String?
  dentalHistory         String?
  allergies             String?
  currentMedications    String?
  preferredPaymentMode  String?
  insuranceProvider     String?
  sumInsured            Float?
  userId                String
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  dentalConcerns        String?
  previousDentalWork    String?
  previousSurgeries     String?
  appointments          Appointment[]
  documents             Document[]
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  treatments            Treatment[]
  clinicalImages        ClinicalImage[]
  consents              PatientConsent[]
  clinicId              String?
  createdByExternal     Boolean       @default(false)
  clinic                Clinic?       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  invoices              Invoice[]

  @@index([userId])
  @@index([mobileNumber])
  @@index([clinicId])
  @@index([createdByExternal])
}

model Treatment {
  id               String    @id @default(cuid())
  patientId        String
  treatmentDate    DateTime
  chiefComplaint   String
  clinicalFindings String
  diagnosis        String
  treatmentPlan    String
  prescription     String
  notes            String?
  cost             Float
  paidAmount       Float     @default(0)
  selectedTeeth    String[]
  userId           String
  followUpDate     DateTime?
  followUpNotes    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  patient          Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinicalImages   ClinicalImage[]
  consents         PatientConsent[]
  invoices         Invoice[]

  @@index([patientId])
  @@index([userId])
}

model Appointment {
  id        String   @id @default(cuid())
  patientId String
  date      DateTime
  time      String
  type      String
  status    String   @default("scheduled")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
}

model Document {
  id        String   @id @default(cuid())
  patientId String
  name      String
  type      String
  url       String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model ClinicalImage {
  id          String            @id @default(cuid())
  patientId   String
  treatmentId String?
  type        ClinicalImageType
  title       String
  toothNumber String?
  notes       String?
  fileUrl     String
  fileSize    Int
  mimeType    String
  capturedBy  String
  capturedAt  DateTime          @default(now())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  patient     Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment   Treatment?        @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  capturedByUser User           @relation(fields: [capturedBy], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([treatmentId])
  @@index([capturedBy])
  @@index([capturedAt])
}

model ConsentTemplate {
  id          String   @id @default(cuid())
  name        String
  title       String
  body        String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  consents    PatientConsent[]

  @@index([isActive])
}

model PatientConsent {
  id            String         @id @default(cuid())
  patientId     String
  treatmentId   String?
  templateId    String
  signedBy      String
  signedByUserId String
  signedAt      DateTime
  signatureUrl String?
  pdfUrl        String
  status        ConsentStatus  @default(SIGNED)
  notes         String?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment     Treatment?     @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  template      ConsentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  signedByUser  User           @relation("SignedBy", fields: [signedByUserId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([treatmentId])
  @@index([templateId])
  @@index([signedByUserId])
  @@index([status])
  @@index([signedAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String?
  username  String?
  ipAddress String
  userAgent String?
  successful Boolean
  createdAt DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entityType String?
  entityId  String?
  ipAddress String?
  userAgent String?
  metadata  String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      Role
  token     String   @unique
  clinicId  String
  status    String   @default("pending")
  createdBy String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([token])
  @@index([email])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  patientId      String
  treatmentId    String?
  clinicId       String?
  createdBy      String
  amount         Float
  taxAmount      Float         @default(0)
  discountAmount Float         @default(0)
  totalAmount    Float
  status         String        @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  paidDate       DateTime?
  dueDate        DateTime
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  patient        Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment      Treatment?    @relation(fields: [treatmentId], references: [id])
  clinic         Clinic?       @relation(fields: [clinicId], references: [id])
  user           User          @relation(fields: [createdBy], references: [id])
  items          InvoiceItem[]
  payments       Payment[]

  @@index([patientId])
  @@index([clinicId])
  @@index([treatmentId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([createdAt])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Float
  amount      Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id          String   @id @default(cuid())
  invoiceId   String
  amount      Float
  paymentDate DateTime @default(now())
  method      String   // CASH, CARD, UPI, BANK_TRANSFER
  reference   String?
  notes       String?
  recordedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [recordedBy], references: [id])

  @@index([invoiceId])
  @@index([paymentDate])
}

model Supplier {
  id        String   @id @default(cuid())
  clinicId  String
  name      String
  email     String?
  phone     String?
  address   String?
  gstIn     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  items     InventoryItem[]

  @@index([clinicId])
}

model InventoryItem {
  id          String   @id @default(cuid())
  clinicId    String
  supplierId  String?
  name        String
  description String?
  category    String
  sku         String?
  unit        String
  unitPrice   Float
  quantity    Int      @default(0)
  minQuantity Int      @default(10)
  expiryDate  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinic      Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  stockMovements StockMovement[]

  @@index([clinicId])
  @@index([supplierId])
  @@index([category])
  @@index([sku])
}

model StockMovement {
  id          String   @id @default(cuid())
  itemId      String
  userId      String
  type        String   // IN, OUT, ADJUSTMENT
  quantity    Int
  previousQty Int
  newQty      Int
  reason      String?
  reference   String?
  createdAt   DateTime @default(now())

  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id])

  @@index([itemId])
  @@index([userId])
  @@index([createdAt])
}
