generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                  String      @id @default(cuid())
  name                String?
  email               String?     @unique
  username            String?     @unique
  emailVerified       DateTime?
  password            String?
  image               String?
  role                Role        @default(CLINIC_DOCTOR)
  isExternal          Boolean     @default(false)
  clinicId            String?
  lastLoginAt         DateTime?
  failedLoginAttempts Int         @default(0)
  lockedUntil         DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  accounts            Account[]
  patients            Patient[]
  sessions            Session[]
  treatments          Treatment[]
  clinic              Clinic?     @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([username])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Clinic {
  id                    String             @id @default(cuid())
  name                  String
  clinicCode            String             @unique
  type                  ClinicType         @default(CLINIC)
  email                 String
  phone                 String?
  address               String?
  city                  String?
  state                 String?
  logo                  String?
  isActive              Boolean            @default(true)
  ownerName             String
  ownerEmail            String
  planType              String             @default("free")
  maxUsers              Int                @default(5)
  onboardingComplete    Boolean            @default(false)
  onboardingStep        Int                @default(1)
  termsAcceptedAt       DateTime?
  privacyAcceptedAt     DateTime?
  subscriptionStatus    SubscriptionStatus @default(TRIAL)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  billingEmail          String?
  mrr                   Float              @default(0)
  lastPaymentDate       DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  invitations           Invitation[]
  patients              Patient[]
  users                 User[]
  inventoryItems        InventoryItem[]
  suppliers             Supplier[]
  invoices              Invoice[]

  @@index([clinicCode])
  @@index([subscriptionStatus])
}

model Patient {
  id                    String           @id @default(cuid())
  firstName             String
  lastName              String
  dateOfBirth           DateTime
  gender                String
  bloodGroup            String?
  height                Float?
  weight                Float?
  mobileNumber          String
  alternateMobileNumber String?
  email                 String?
  address               String
  city                  String
  state                 String
  pinCode               String
  aadharNumber          String?
  emergencyContactName  String?
  emergencyMobileNumber String?
  relationship          String?
  medicalHistory        String?
  dentalHistory         String?
  allergies             String?
  currentMedications    String?
  previousSurgeries     String?
  dentalConcerns        String?
  previousDentalWork    String?
  preferredPaymentMode  String?
  insuranceProvider     String?
  sumInsured            Float?
  userId                String
  clinicId              String?
  createdByExternal     Boolean          @default(false)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  appointments          Appointment[]
  documents             Document[]
  clinic                Clinic?          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  treatments            Treatment[]
  invoices              Invoice[]
  clinicalImages        ClinicalImage[]
  consents              PatientConsent[]

  @@index([userId])
  @@index([mobileNumber])
  @@index([createdByExternal])
  @@index([clinicId])
}

model Treatment {
  id               String            @id @default(cuid())
  patientId        String
  treatmentDate    DateTime
  chiefComplaint   String
  clinicalFindings String
  diagnosis        String
  treatmentPlan    String
  prescription     String
  notes            String?
  cost             Float
  paidAmount       Float             @default(0)
  selectedTeeth    String[]
  toothChart       String? // JSON field for tooth restoration map
  userId           String
  followUpDate     DateTime?
  followUpNotes    String?
  status           TreatmentStatus   @default(IN_PROGRESS)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices         Invoice[]
  clinicalImages   ClinicalImage[]
  consents         PatientConsent[]
  visits           TreatmentVisit[]
  prescriptions    PrescriptionPDF[]

  @@index([patientId])
  @@index([userId])
  @@index([status])
}

model Appointment {
  id        String   @id @default(cuid())
  patientId String
  date      DateTime
  time      String
  type      String
  status    String   @default("scheduled")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
}

model Document {
  id         String   @id @default(cuid())
  patientId  String
  name       String
  type       String
  url        String
  notes      String?
  uploadedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      Role
  token     String   @unique
  clinicId  String
  status    String   @default("pending")
  createdBy String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([token])
  @@index([email])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model LoginAttempt {
  id         String   @id @default(cuid())
  email      String?
  username   String?
  ipAddress  String
  userAgent  String?
  successful Boolean
  createdAt  DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  ipAddress  String?
  userAgent  String?
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model InventoryItem {
  id             String          @id @default(cuid())
  name           String
  category       String
  sku            String?         @unique
  description    String?
  unit           String
  quantity       Int             @default(0)
  minQuantity    Int             @default(10)
  maxQuantity    Int?
  unitPrice      Float
  supplierId     String?
  location       String?
  expiryDate     DateTime?
  batchNumber    String?
  clinicId       String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  clinic         Clinic?         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  supplier       Supplier?       @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  stockMovements StockMovement[]

  @@index([clinicId])
  @@index([supplierId])
  @@index([category])
  @@index([sku])
}

model StockMovement {
  id          String        @id @default(cuid())
  itemId      String
  type        MovementType
  quantity    Int
  previousQty Int
  newQty      Int
  reason      String?
  reference   String?
  userId      String
  createdAt   DateTime      @default(now())
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([userId])
  @@index([createdAt])
}

model Supplier {
  id            String          @id @default(cuid())
  name          String
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  pinCode       String?
  taxId         String?
  paymentTerms  String?
  notes         String?
  isActive      Boolean         @default(true)
  clinicId      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  clinic        Clinic?         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  items         InventoryItem[]

  @@index([clinicId])
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  patientId      String
  treatmentId    String?
  amount         Float
  taxAmount      Float         @default(0)
  discountAmount Float         @default(0)
  totalAmount    Float
  status         InvoiceStatus @default(PENDING)
  dueDate        DateTime
  paidDate       DateTime?
  notes          String?
  clinicId       String?
  createdBy      String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  patient        Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment      Treatment?    @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  clinic         Clinic?       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  payments       Payment[]
  items          InvoiceItem[]

  @@index([patientId])
  @@index([treatmentId])
  @@index([clinicId])
  @@index([invoiceNumber])
  @@index([status])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitPrice   Float
  amount      Float
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  amount        Float
  paymentMethod PaymentMethod
  paymentDate   DateTime      @default(now())
  transactionId String?
  status        PaymentStatus @default(COMPLETED)
  notes         String?
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentDate])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  metadata  String?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  emailNotifications   Boolean  @default(true)
  smsNotifications     Boolean  @default(false)
  appointmentReminders Boolean  @default(true)
  paymentReminders     Boolean  @default(true)
  inventoryAlerts      Boolean  @default(true)
  systemUpdates        Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
}

enum Role {
  ADMIN
  CLINIC_DOCTOR
  HYGIENIST
  RECEPTIONIST
  EXTERNAL_DOCTOR
}

enum ClinicType {
  INDIVIDUAL_PRACTICE
  CLINIC
  MULTI_LOCATION_CLINIC
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  EXPIRED
  DAMAGED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  UPI
  BANK_TRANSFER
  CHEQUE
  INSURANCE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  PAYMENT_REMINDER
  PAYMENT_RECEIVED
  INVENTORY_LOW_STOCK
  INVENTORY_OUT_OF_STOCK
  SYSTEM_UPDATE
  GENERAL
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
}

enum TreatmentStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum ClinicalImageType {
  XRAY
  INTRAORAL
  EXTRAORAL
  PERIAPICAL
  BITEWING
  PANORAMIC
  CEPHALOMETRIC
  CBCT
  BEFORE_TREATMENT
  DURING_TREATMENT
  AFTER_TREATMENT
  OTHER
}

enum ConsentStatus {
  PENDING
  SIGNED
  DECLINED
  EXPIRED
}

enum VisitStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Clinical Images - X-rays, photos, scans
model ClinicalImage {
  id          String            @id @default(cuid())
  patientId   String
  treatmentId String?
  type        ClinicalImageType
  toothNumber String? // Optional tooth reference
  title       String
  notes       String?
  fileUrl     String
  fileSize    Int? // in bytes
  mimeType    String?
  capturedBy  String // userId
  capturedAt  DateTime          @default(now())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  patient     Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment   Treatment?        @relation(fields: [treatmentId], references: [id], onDelete: SetNull)

  @@index([patientId])
  @@index([treatmentId])
  @@index([type])
  @@index([capturedAt])
}

// Consent Templates - Reusable consent forms
model ConsentTemplate {
  id                String           @id @default(cuid())
  name              String
  title             String
  body              String // HTML/Markdown content
  category          String? // e.g., "General", "Surgical", "Orthodontic"
  requiresSignature Boolean          @default(true)
  isActive          Boolean          @default(true)
  clinicId          String?
  createdBy         String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  consents          PatientConsent[]

  @@index([clinicId])
  @@index([isActive])
}

// Patient Consents - Signed consent instances
model PatientConsent {
  id             String          @id @default(cuid())
  patientId      String
  treatmentId    String?
  templateId     String
  signedBy       String // Patient name
  signedByUserId String? // If signed by staff on behalf
  signedAt       DateTime?
  signatureUrl   String? // Path to signature image
  pdfUrl         String? // Path to generated consent PDF
  status         ConsentStatus   @default(PENDING)
  notes          String?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  patient        Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment      Treatment?      @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  template       ConsentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([treatmentId])
  @@index([templateId])
  @@index([status])
}

// Treatment Visits - Multi-visit tracking
model TreatmentVisit {
  id          String      @id @default(cuid())
  treatmentId String
  visitNumber Int
  visitDate   DateTime
  status      VisitStatus @default(COMPLETED)
  notes       String?
  procedures  String? // Procedures performed this visit
  cost        Float       @default(0)
  duration    Int? // Duration in minutes
  performedBy String // userId
  isBilled    Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  treatment   Treatment   @relation(fields: [treatmentId], references: [id], onDelete: Cascade)

  @@index([treatmentId])
  @@index([visitDate])
  @@index([status])
}

// Prescription PDFs - Generated prescription metadata
model PrescriptionPDF {
  id           String    @id @default(cuid())
  treatmentId  String
  patientId    String
  pdfUrl       String
  medications  String // JSON array of medications
  instructions String?
  generatedBy  String // userId
  generatedAt  DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  treatment    Treatment @relation(fields: [treatmentId], references: [id], onDelete: Cascade)

  @@index([treatmentId])
  @@index([patientId])
  @@index([generatedAt])
}

// Super Admin Model - Platform administrators
model SuperAdmin {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String // bcrypt hashed
  name        String
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
}

// Platform Metrics - Track SaaS metrics over time
model PlatformMetric {
  id         String   @id @default(cuid())
  date       DateTime @default(now())
  metricType String // MRR, ACTIVE_CLINICS, TOTAL_USERS, etc.
  value      Float
  metadata   String? // JSON for additional data
  createdAt  DateTime @default(now())

  @@index([metricType, date])
}
